<! DOCTYPE html >
<html ng-app="FallDetector">
<head>
	<title>Fall Detector data</title>
	
	<script src="./js/angular_1.2.3.js"></script>
    <script src="./js/angular-resource.js"></script>
	<script>
        "use strict";
        angular.module('FallDetector', [ 'angular-websocket', 'ngResource'], function(){
    
        }).controller('controller', function ($q, $scope, $http, $resource, WebSocket, $interval) {
            
            var testData = {
                x: [1, 3, 3, 2, 3 ],
                y: [],
                z: []
                };
                
            $scope.data = {
                x: [],
                y: [],
                z: []
            };
            
            $scope.options = {
                threshold : 25,
                pause: false,
                pausing : false,
                yaxis: {
                    show: true,
                
//                    color: null or color spec
//                    tickColor: null or color spec
                
                    min: -90,
                    max: 90
                
                
//                    ticks: null or number or ticks array or (fn: axis -> ticks array)
//                    tickSize: number or array
//                    minTickSize: number or array
//                
//                    alignTicksWithAxis: null or number
                } 
             };
            
            $scope.dataStr = JSON.stringify(testData);
            
            $scope.$watch('dataStr', function(newData, oldData){
                try{
                    var data = JSON.parse(newData);
                }catch(e){
                    //parse errors are ignored.
                    return;
                }
                //sendData(newData);

            });
            
            $scope.saveData = function (){
                var params = {method: 'POST', url: '/accel/save', data: $scope.data}
                $http(params).then(
                function(data){

                }, function(data){                    
                    $scope.test = "Error sending data to server.";
                });
            }
            
            function parseData(data1, data2){
                
                function parseSingleAxis(axis){
                    var series = [];
                    if(axis == undefined)
                        return series;
                    for(var i = 0; i < axis.length; i++){
                        series.push([i, axis[i] * 5]);                    
                    }                    
                    return series                    
                }
                
                var lineBelow = {label: "Threshold", color: 'black', data : [[0, -$scope.options.threshold], [200, -$scope.options.threshold]]}
                var lineTop = {color: 'black', data : [[0, $scope.options.threshold], [200, $scope.options.threshold]]}
                
                return [ lineBelow, lineTop,
                    {label: "Acceleraometer: X", data: parseSingleAxis( data1.X)}, 
                    {label: "Acceleraometer: Y", data: parseSingleAxis( data1.Y)},
                    {label: "Acceleraometer: Z", data: parseSingleAxis( data1.Z)}//,
//                    {label: "Gyro: X", data: parseSingleAxis( data2.X)}, 
//                    {label: "Gyro: Y", data: parseSingleAxis( data2.Y)},
//                    {label: "Gyro: Z", data: parseSingleAxis( data2.Z)} 
                    
                    ];
            }
            
            
            
            function verifyThresshold(){
                var d = $scope.data;
                for(var j = 2; j < d.length; j++){
                    for(var i = 0; i < d[j].data.length; i++){
                        if(d[j].data[i][1] > $scope.options.threshold || d[j].data[i][1] < -$scope.options.threshold)
                            $scope.options.pausing = true;
                    }
                }
            }
            
            function getAccel(){
//                $q.all([$http({method: 'GET', url: '/gyro', data: $scope.data}),
//                $http({method: 'GET', url: '/accel', data: $scope.data})]).
                $http({method: 'GET', url: '/accel', data: $scope.data}).
                then(function(data) {
                        $scope.data = parseData(data.data)//, data[1].data);
                        verifyThresshold();
                    },function(data, status, headers, config) {
                        $scope.test = "Error loading data from server.";
                    });
            };
            
            var intervalPromise;
            $scope.$watch('options.pause', function(value){

                if(value)
                  $interval.cancel(intervalPromise);                    
                else
                  intervalPromise = $interval(getAccel, 200);

            });
            
            $scope.$watch('options.pausing', function(value){
               if(value) 
                    $interval(function(){
                        $scope.options.pause = true;
                        $scope.options.pausing = false;
                    }, 5000, 1);
                
            });

            
            
    });
	</script>
	
	<script src="./js/FallDetector-Module.js"></script>
	<script src="./js/flot_graf_directive.js"></script>
	<script src="./js/angular-websocket.js"></script>
	
	<script src="./js/flot/jquery.js"></script>
	<script src="./js/flot/jquery.flot.js"></script>
    
    <style>
        button {
            margin: 0;
        }
        input {
            min-width: 100px;
        }
        select {
            min-width: 100px;
        }
    </style>
</head>
<body ng-controller="controller">
    <div style="float: left;">
    	<div flot-graf data="data" options="options" style="height: 900px; width: 800px; float: left;"" > 
        </div>
        <div style="float: left;">
            <p>Threshold</p>
            <input ng-model="options.threshold" style="width: 80px;"/><br>
            <button ng-show="options.pause == false" ng-click="options.pause = true" style="width: 60px;">Pause</button>
            <button ng-show="options.pause == true" ng-click="options.pause = false" style="width: 60px;">Start</button>
            <button ng-click="saveData()">Save</button>
            <p>SavedData</p>
            <select>
                <option>None<option>
            </select><br>
        </div>
    </div>
		
</body>
</html>
